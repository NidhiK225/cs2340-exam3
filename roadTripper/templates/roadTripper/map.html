{% extends 'base.html' %}
{% load static %}

{% block content %}

<div id="search-container">
    <input id="search" type="text" placeholder="Enter a location">
    <button id="searchBtn">Go</button>
</div>

<div id="map" style="height:600px;width:100%"></div>

<script>
    let map;
    let markers = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 39.8283, lng: -98.5795},
            zoom: 4
        });

        const input = document.getElementById("search");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry) return alert("No details available for that location");
            map.setCenter(place.geometry.location);
            map.setZoom(12);

            fetchPosts(place.geometry.location.lat(), place.geometry.location.lng());

        });

    }

        async function fetchPosts(lat, lng) {
            console.log("Fetching posts for:", lat, lng);
            markers.forEach(m => m.setMap(null));
            markers = [];

            try {
                const radius = 1000000;
                const res = await fetch(`/roadTripper/posts/?lat=${lat}&lng=${lng}&radius=100000`);
                const posts = await res.json();
                console.log("Posts received from backend:", posts);
                displayMarkers(posts);
            } catch(err) {
                console.error(err);
            }


        }
        function displayMarkers(posts) {
            posts.forEach(post => {
                const marker = new google.maps.Marker({
                    position: {lat: post.lat, lng: post.lng },
                    map,
                    title: post.username,
                    icon: {
                        url: "{% static 'img/profilePic.jpg' %}",
                        scaledSize: new google.maps.Size(40, 40),
                    },
                });


                // const infoWindow = new google.maps.InfoWindow({
                //     content: `
                //     <strong>${post.username}</strong><br>
                //     ${post.caption}<br>
                //     <img src="${post.image || 'https://via.placeholder.com/100'}" width="100"/>
                //     ${new Date(post.timestamp).toLocaleString()}
                //     `
                // });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="width: 250px; font-family: sans-serif; border: 1px solid #ddd; border-radius: 3px; background-color: white;">
                            <div style="display: flex; align-items: center; padding 8px 10px;">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #ccc; margin-right: 8px;"></div>
                                <strong style="font-size: 14px;">${post.username || 'ROAD TRIPPER USERNAME'}</strong>
                                </div>

                                <div style="width: 100%; height: auto; border-top: 1px solid #eee; border-bottom: 1px solid #eee;">
                                    <img
                                        src = "${post.image}"
                                        alt = "post image"
                                        style = "width: 100%; display: block; max-height: 200px; object-fit:cover;"
                                        />
                                        </div>

                                        <div style="padding: 8px 10px;">
                                            <div style = "margin-bottom: 8px; font-size: 18px;">
                                                <span>&#x2764;</span> <span style="margin-left: 10px;">&#x1F4AD;</span> <span style="float: right;">&#x1F516;</span> </div>

                                            <p style="margin: 0; font-size: 14px; line-height: 1.2;">
                                                <strong>${post.username || 'user'}:</strong>
                                                ${post.caption || 'CAPTION'}<br>
                                                <span style="color: #00376b; font-size: 12px;">
                                                    ${ (post.tagged_friends && post.tagged_friends.length > 0) ?
                                                        `Tagged: ${post.tagged_friends.map(friend => `@${friend}`).join(', ')}`
                                                    : ''

                                                }

                                                    </span>
                                            </p>
                                            <div style="color: #999; font-size: 10px; margin-top: 5px;">
                    ${new Date(post.timestamp).toLocaleDateString()}
                </div>
            </div>
        </div>
    `
});



                marker.addListener("click", () => infoWindow.open(map, marker));
                markers.push(marker);
            });
        }


</script>

<script src ="https://maps.googleapis.com/maps/api/js?key=AIzaSyCB1Yppcqoe9_A8euT_t-Pz2odNPTlBtw0&libraries=places&callback=initMap" async defer></script>

{%endblock%}